Go语言垃圾回收
==

## 1. Gc 垃圾回收机制

### 1.1 常见的垃圾回收方法

#### 引用计数
- 引用计数：对每个对象维护一个引用计数，当引用该对象的对象被销毁时，引用计数减1，当引用计数器为0是回收该对象
- 优点：对象可以很快的被回收，不会出现内存耗尽或达到某个阀值时才回收
- 缺点：不能很好地处理循环引用，而且实时维护引用计数，有也一定的代价

#### 标记-清除
- 从根变量开始遍历所有引用的对象，引用的对象标记为"被引用"，没有被标记的进行回收
- 优点：解决了引用计数的缺点。
- 缺点：需要STW（stop the word），即要暂时停掉程序运行
- 代表语言：Golang(其采用三色标记法)

#### 分代收集
- 按照对象生命周期长短划分不同的代空间，生命周期长的放入老年代，而短的放入新生代，不同代有不同的回收算法和回收频率
- 优点：回收性能好
- 缺点：实现复杂
- 代表语言： JAVA


### 1.2 Gc过程

#### 概述
- Go的GC自打出生的时候就开始被人诟病，但是在引入v1.5的三色标记和v1.8的混合写屏障后，正常的GC已经缩短到10us左右，已经变得非常优秀

##### go v1.1：标记-清除法，整个过程都需要STW
- go v1.3：标记-清除法，标记过程仍然需要STW但清除过程并行化，gc pause约几百ms
- go v1.5：引入插入写屏障技术的三色标记法，仅在堆空间启动插入写屏障，全部扫描后需要STW重新扫描栈空间，gc pause耗时降到10ms以下
- go v1.8：引入混合写屏障技术的三色标记法，仅在堆空间启动混合写屏障，不需要在GC结束后对栈空间重新扫描，gc pause时间降低至0.5ms以下
- go v1.14：引入新的页分配器用于优化内存分配的速度

#### 三色标记原理
- 1、首先把所有的对象都放到白色的集合中
- 2、从根节点开始遍历对象，遍历到的白色对象从白色集合中放到灰色集合中
- 3、遍历灰色集合中的对象，把灰色对象引用的白色集合的对象放入到灰色集合中，同时把遍历过的灰色集合中的对象放到黑色的集合中
- 4、循环步骤3，直到灰色集合中没有对象
- 步骤4结束后，白色集合中的对象就是不可达对象，也就是垃圾，进行回收

#### 辅助GC
- 由于Golang使用了并发式的垃圾回收，将原本需要STW较长时间的GC过程分散到多次小规模的GC。
- 当用户分配内存的速度超过GC回收速度时，Golang会通过辅助GC暂停用户程序进行垃圾回收，防止内存因分配对象速度过快消耗殆尽的问题

#### GC触发时机

##### 三个前提条件
```
memstats.enablegc：允许垃圾回收
panicking == 0：程序没有panic
gcphase == _GCoff：处于_Gcoff阶段
```

##### 触发时机
```
gcTriggerHeap：堆内存的大小达到一定阈值
gcTriggerTime：距离上一次垃圾回收超过一定阈值时
gcTriggerCycle：如果当前没有启动GC则开始新一轮的GC
```

### 1.3 STW

#### 作用
- 垃圾回收线程通常会采用 STW 的方式来防止扫描后的对象发生引用关系变化

### 1.4 混合写屏障

#### 来由
如果我们想要保证在垃圾回收扫描的过程中，保证其他线程正常运行，则需要采用一种方案保证对象引用变动会被记录，避免发生错乱

#### 原理
- 使用屏障技术可以使得用户程序和三色标记过程并发执行，我们只需要达成下列任意一种三色不变性：
- 强三色不变性：黑色对象永远不会指向白色对象
- 弱三色不变性：黑色对象指向的白色对象至少包含一条由灰色对象经过白色对象的可达路径

#### 读写屏障说明
- GC中使用的内存读写屏障技术指的是编译器会在编译期间生成一段代码，
- 该代码在运行期间用户读取、创建或更新对象指针时会拦截内存读写操作，相当于一个hook调用，根据hook时机不同可分为不同的屏障技术。
- 由于读屏障Read barrier技术需要在读操作中插入代码片段从而影响用户程序性能，所以一般使用写屏障技术来保证三色标记的稳健性。

#### 对比STW
- 我们讲内存屏障技术解决了三色标记法的STW缺点，并不是指消除了所有的赋值器挂起问题
- 需要分清楚STW方法是全局性的赋值器挂起而内存屏障技术是局部的赋值器挂起

#### 包含内容
- 插入写屏障
- 删除写屏障

#### 混合写屏障逻辑
- GC开始时将栈上所有对象标记为黑色，无须STW
- GC期间在栈上创建的新对象均标记为黑色
- 将被删除的下游对象标记为灰色
- 将被添加的下游对象标记为灰色

### 参考
- https://zhuanlan.zhihu.com/p/297177002