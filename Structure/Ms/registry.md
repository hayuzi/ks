注册中心与服务注册
==

### 服务注册与服务发现

服务注册与发现涉及到服务提供者与服务调用者之间的交互。 在客户端调用服务过程中，需要知道有哪些服务、特定服务所在的位置信息、服务的存活状态等等信息。 在这种情况下，服务注册中心主要提供服务集中管理，存活检测，以及调度负载均衡等功能。

#### 微服务负载均衡分析

我们先了解一下负载分配的方式：

- 基于连接的负载
    - 固定连接，客户端请求发送到固定服务
- 基于调用的负载
    - 不固定连接
    - 请求可以均分到不同的服务上
    - 分配负载涉及到负载均衡策略

负载均衡的类型

- 客户端负载均衡
    - 调用时，由客户端到注册中心获取服务提供者清单，并使用特定负载均衡策略在服务清单中选择一个或者多个服务进行调用
    - 优点：高性能，去中心化，不需要借助独立的外部负载均衡组件
    - 缺点：实现成本较高 (如不同语言需要各自的SDK、清单过期需要反补等)
- 服务端负载均衡
    - 服务端负载，又被称为代理模式，指在服务侧搭设独立的负载均衡器，负载均衡器再根据给定目标名称找到适合调用的服务实例
    - 具备负载均衡和反向代理两项功能
    - 优点：简单、透明
    - 缺点：外部负载均衡器可能成为性能瓶颈，且必须要保证高可用

微服务负载均衡设计核心思路：

- 客户端根据服务名发起请求
- 名称解析器解析服务名并返回
- 客户端根据服务端类型选择相应的策略
- 最后根据不同的策略进行实际调用

### 基本原理介绍

#### 以注册中心Consul为例

对于服务端来说:

- 服务端开启服务的时候，将自身的信息通过注册中心提供的接口注册到Consul
- 服务端开启的同时提供一个健康检查的接口，便于Consul来定期检查服务节点的健康状态
- Consul按照服务注册时候的配置，定时请求服务的健康检查接口
- 如果检测存活，则正常；检测不存活，Consul标记节点为异常状态，并会在异常状态持续一定时间之后将服务从Consul中移除
    - 健康检查策略可以使用注册中心请求服务，也可以采用服务上报的形式来实现（其他注册中心机制）

对于客户端来说:

- 客户端在请求具体服务之前,需要预先从注册中心获取健康服务节点列表
    - **应对注册中心故障**: 可以缓存服务节点列表，在注册中心故障的时候，可以依赖缓存数据去访问服务
- 客户端拿到服务节点列表之后，需要使用负载均衡策略，选择需要请求的节点
- 建立连接并调用服务API

### 几个常见的开源服务注册中心

- zookeeper
- etcd
- Eureka
    - 2.x版本已经在2018年不再开源
- Consul
- Nacos

### 相关文章

- https://zhuanlan.zhihu.com/p/409154290