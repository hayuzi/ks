Kafka（二）
==

### 5. Kafka 构建数据管道

#### 构建数据管道时需要考虑的问题

- 及时性
- 可靠性
- 高吞吐量和动态吞吐量
- 数据格式
- 转换
    - ETL 提取-转换-加载（Extract-Transform-Load）
    - ELT 提取-加载-转换（高保真数据管道、数据湖架构）
- 安全性
- 故障处理能力
- 耦合性和灵活性

#### Kafka Connect

预留

### 6. 跨集群数据镜像

#### 6.1 多集群架构

##### 跨数据中心通信的限制

- 高延时
- 有限的带宽
- 一些架构原则
    - 每个数据中心至少需要一个集群
    - 每两个数据中心之间的数据复制要做到每个事件仅复制一次（除非出现错误需要重试）
    - 如果有可能，尽量从远程数据中心读取数据，而不是向远程数据中心写入数据

##### 架构模式

- Hub和Spoke（星形辐射架构）
    - 一个中央数据中心,多个本地数据中心,本地数据中心向中央数据中心同步数据
    - 优点: 数据只会在本地数据中心生成，而且每个数据中心的数据只会被镜像到中央数据中心一次
    - 缺点：一个数据中心的数据不能被另一个数据中心访问
- 双活架构
    - 有两个或者多个数据中心需要共享数据并且每个数据中心都可以生产和读取数据时候，可以使用双活架构
    - 优点：可以就近为用户提供服务，弹性和冗余
    - 缺点：循环复制不好处理、数据冲突难以解决
    - 方案：topic带命名空间前缀，单向镜像；通配符方式订阅主题
    - 挑战：每个数据中心都要进行镜像，而且是双向的。所一镜像进程数量是乘积
- 主备架构
    - 备用集群只做数据冗余，可以在主集群异常的时候选择使用
- 延展集群
    - 延展集群不是多个集群而是单个集群，不需要对延展集群进行镜像，多个数据中心，位于一个集群中
    - Kafka内置功能，需要通过配置来实现。
    - 优势：同步复制

##### 失效备援的的内容

- 数据丢失和不一致性需要处理
- 失效备援之后的起始偏移量
    - 偏移量自动重置（消费者的配置选项）
    - 复制偏移量主题（不能保证完全一致，还是有丢失或重复的可能）
    - 基于时间的失效备援
    - 偏移量外部映射
- 失效备援之后
    - 防止数据不一致，建议清空之前的集群数据再重新把数据镜像回来
- 关于集群发现
    - 建议不要硬编码集群主机地址

##### Kafka 的 MirrorMaker

用于在数据中心之间镜像数据 （待完善）

##### 其他跨集群的镜像方案

- 优步的 uReplicator
- Confluent 的 Replicator
